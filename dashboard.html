<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Mutualan TikTok</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Style untuk tombol filter aktif */
        .filter-btn-active {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            font-weight: 700;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100">

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">üë• Mutualan TikTok</h1>
            <div id="navUserSection" class="text-sm flex flex-wrap gap-2 items-center">
                </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto mt-6 px-4">

        <div id="flashMessage" class="hidden p-4 mb-4 rounded-lg text-sm"></div>

        <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="bg-white p-4 shadow rounded-lg text-center">
                <p class="text-sm text-gray-500">Total Member Aktif</p>
                <p id="statTotalMembers" class="text-2xl font-bold">0</p>
            </div>
                <div class="bg-white p-4 shadow rounded-lg text-center">
                    <p class="text-sm text-gray-500">Member Online</p>
                    <p id="statOnlineMembers" class="text-2xl font-bold text-teal-600">0</p>
                </div>
            <div class="bg-white p-4 shadow rounded-lg text-center">
                <p class="text-sm text-gray-500">Mengikutimu</p>
                <p id="statYouAreFollowing" class="text-2xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-white p-4 shadow rounded-lg text-center">
                <p class="text-sm text-gray-500">Kamu mengikuti</p>
                <p id="statFollowingYou" class="text-2xl font-bold text-green-600">0</p>
            </div>
        </section>


        <div class="mb-4 flex justify-between items-center flex-wrap gap-2">
            <h2 class="text-lg font-semibold text-gray-800">üìã Daftar Anggota</h2>
            <div class="flex gap-2">
                <button id="filterAll" class="filter-btn px-3 py-1 rounded bg-gray-200 text-sm filter-btn-active">Semua</button>
                <button id="filterNotFollback" class="filter-btn px-3 py-1 rounded bg-gray-200 text-sm">Belum Follback</button>
            </div>
        </div>

        <div class="hidden sm:block overflow-x-auto">
            <table class="w-full bg-white shadow rounded-lg">
                <thead class="bg-gray-200 text-sm text-gray-700 uppercase">
                    <tr>
                        <th class="px-4 py-3 text-left">Username</th>
                        <th class="px-4 py-3 text-center">No. WA</th>
                        <th class="px-4 py-3 text-center">Skor</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="text-gray-700"></tbody>
            </table>
        </div>

        <div id="mobileList" class="sm:hidden grid grid-cols-1 gap-4"></div>

    </main>
    
    <footer class="mt-10 mb-6 text-center text-gray-500 text-sm">
        &copy; <span id="currentYear"></span> Mutualan TikTok
    </footer>

    <script>
        // --- !!! PERINGATAN KEAMANAN !!! ---
        // JANGAN PERNAH MENARUH API KEY DAN KONFIGURASI SENSITIF LANGSUNG DI KODE CLIENT-SIDE
        // YANG AKAN DIPUBLIKASIKAN. Gunakan Firebase Hosting dengan konfigurasi otomatis atau
        // Environment Variables untuk melindungi kredensial Anda.
        const firebaseConfig = {
        apiKey: "AIzaSyDcgwRAwrLHKhtTmcmWucb1z3qTqbW0nbU",
        authDomain: "saling-follow.firebaseapp.com",
        databaseURL: "https://saling-follow-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "saling-follow",
        storageBucket: "saling-follow.firebasestorage.app",
        messagingSenderId: "1094414083730",
        appId: "1:1094414083730:web:d92a44972e226a5429284b",
        measurementId: "G-N3S79LL85E"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // DOM Elements
        const navUserSection = document.getElementById("navUserSection");
        const flashMessage = document.getElementById("flashMessage");
        const statTotalMembers = document.getElementById("statTotalMembers");
        const statYouAreFollowing = document.getElementById("statYouAreFollowing");
        const statFollowingYou = document.getElementById("statFollowingYou");
        const tableBody = document.getElementById("tableBody");
        const mobileList = document.getElementById("mobileList");
        const currentYear = document.getElementById("currentYear");
        const filterButtons = document.querySelectorAll(".filter-btn");
        const statOnlineMembers = document.getElementById("statOnlineMembers");

        // App State
        let currentUserData = null;
        let allUsersData = {};
        let activeFilter = "all";

        // Global references to store active listeners for cleanup
        let currentUserRef = null;
        let allUsersRef = null;
        let presenceRef = null;
        let connectedRef = null;

        currentYear.innerText = new Date().getFullYear();

        // --- UTILITY FUNCTIONS ---
        function showFlashMessage(text, type = "success") {
            flashMessage.textContent = text;
            flashMessage.className = "p-4 mb-4 rounded-lg text-sm"; // Reset classes
            if (type === "success") {
                flashMessage.classList.add("bg-green-100", "text-green-800");
            } else if (type === "warning") {
                flashMessage.classList.add("bg-yellow-100", "text-yellow-800");
            } else if (type === "info") { // Added for general info messages
                flashMessage.classList.add("bg-blue-100", "text-blue-800");
            } else {
                flashMessage.classList.add("bg-red-100", "text-red-800");
            }
            flashMessage.classList.remove("hidden");
            setTimeout(() => {
                flashMessage.classList.add("hidden");
            }, 4000);
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateNavUser() {
            if (!currentUserData) return;
            navUserSection.innerHTML = `
                <span class="text-gray-700">Hi, <strong>${currentUserData.username}</strong></span>
                <button id="leaderboardBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded text-sm">üèÜ Leaderboard</button>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Logout</button>
            `;
        }
        
        function renderMembers() {
            tableBody.innerHTML = "";
            mobileList.innerHTML = "";
            
            if (!currentUserData) return;

            let filteredUsers = Object.values(allUsersData).filter(user => user.id !== currentUserData.id);

            if (activeFilter === "not_follback") {
                // Tampilkan user yang sudah follow kita ("pending"), tapi kita belum follback
                filteredUsers = filteredUsers.filter(user => {
                    const theyFollowYou = currentUserData.followers && currentUserData.followers[user.id];
                    const youFollowThem = currentUserData.following && currentUserData.following[user.id];
                    return theyFollowYou === "pending" && !youFollowThem;
                });
            }
            
            if (filteredUsers.length === 0) {
                const emptyMessage = `<tr class="border-t"><td colspan="5" class="text-center py-8 text-gray-500">Tidak ada anggota untuk ditampilkan.</td></tr>`;
                tableBody.innerHTML = emptyMessage;
                mobileList.innerHTML = `<div class="bg-white rounded-lg shadow p-4 text-center text-gray-500">Tidak ada anggota untuk ditampilkan.</div>`;
                return;
            }

            filteredUsers.forEach(user => {
                const { statusLabel, actionsHTML } = getStatusAndActions(user);
                
                // For Desktop Table
                const tr = document.createElement("tr");
                tr.className = "border-t hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-4 py-3">${user.username}</td>
                    <td class="px-4 py-3 text-center">${user.whatsapp || "-"}</td>
                    <td class="px-4 py-3 text-center">${user.trust_score || 0}</td>
                    <td class="px-4 py-3 text-center text-xs">${statusLabel}</td>
                    <td class="px-4 py-3 text-center">${actionsHTML}</td>
                `;
                tableBody.appendChild(tr);

                // For Mobile Cards
                const card = document.createElement("div");
                card.className = "bg-white rounded-lg shadow p-4";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold">${user.username}</h3>
                            <p class="text-sm text-gray-500">${user.whatsapp || "-"}</p>
                            <p class="text-sm mt-1">Skor: <span class="font-bold">${user.trust_score || 0}</span></p>
                        </div>
                        <div class="text-right text-xs shrink-0 ml-2">${statusLabel}</div>
                    </div>
                    <div class="mt-4 pt-3 border-t flex gap-2 flex-wrap">${actionsHTML}</div>
                `;
                mobileList.appendChild(card);
            });
        }
        
        function getStatusAndActions(otherUser) {
            const youFollowThem = currentUserData.following && currentUserData.following[otherUser.id];
            const theyFollowYou = currentUserData.followers && currentUserData.followers[otherUser.id];

            let statusLabel = "-";
            let actionsHTML = "";

            if (youFollowThem === "confirmed" && theyFollowYou === "confirmed") {
                statusLabel = `<span class="font-bold text-green-600">Saling Follow</span>`;
                actionsHTML = `<button data-action="unfollow" data-user-id="${otherUser.id}" class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-1 rounded text-sm">Unfollow</button>`;
            
            } else if (theyFollowYou === "pending") {
                statusLabel = `<span class="font-bold text-blue-600">Telah Follow Anda</span><br><span class="text-gray-500 text-xs">(Verifikasi & Follback)</span>`;
                actionsHTML = `
                    <a href="https://www.tiktok.com/@${otherUser.username}" target="_blank" rel="noopener noreferrer" class="inline-block bg-sky-500 hover:bg-sky-600 text-white px-3 py-1 rounded text-sm font-medium align-middle">Cek Profil</a>
                    <button data-action="confirmFollback" data-user-id="${otherUser.id}" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Sudah Follback</button>
                    <button data-action="rejectFollback" data-user-id="${otherUser.id}" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm" title="Klik jika sudah dicek dan ternyata belum follow">Tolak</button>
                `;

            } else if (youFollowThem === "pending") {
                statusLabel = `<span class="font-bold text-yellow-600">Menunggu Follback</span>`;
                actionsHTML = `<span class="text-gray-500 italic text-sm p-1">Menunggu...</span>`;
            
            } else if (youFollowThem === "confirmed") {
                statusLabel = `<span class="text-gray-600">Anda Follow</span>`;
                actionsHTML = `<button data-action="unfollow" data-user-id="${otherUser.id}" class="bg-gray-400 hover:bg-gray-500 text-white px-3 py-1 rounded text-sm">Unfollow</button>`;
            
            } else { // Default state: you haven't followed them
                actionsHTML = `<button data-action="requestFollow" data-user-id="${otherUser.id}" data-username="${otherUser.username}" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">Follow</button>`;
            }
            
            return { statusLabel, actionsHTML };
        }
        
        function updateStats() {
            if (!currentUserData) return;
            
            const totalMembers = Object.keys(allUsersData).length;
            const youAreFollowing = currentUserData.following ? Object.keys(currentUserData.following).filter(key => currentUserData.following[key] === 'confirmed').length : 0;
            const followingYou = currentUserData.followers ? Object.keys(currentUserData.followers).filter(key => currentUserData.followers[key] === 'confirmed').length : 0;
            
            statTotalMembers.textContent = totalMembers;
            statYouAreFollowing.textContent = youAreFollowing;
            statFollowingYou.textContent = followingYou;
        }

        // --- FIREBASE DATA LISTENERS ---
        // This function will set up real-time listeners for user data
        function setupRealtimeListeners(user) {
            // Clear any existing listeners first to prevent duplicates if auth state changes multiple times
            // (though onAuthStateChanged should only fire once on initial load and then on sign in/out)
            if (currentUserRef) currentUserRef.off();
            if (allUsersRef) allUsersRef.off();
            if (presenceRef) presenceRef.off();
            if (connectedRef) connectedRef.off();

            currentUserRef = db.ref(`users/${user.uid}`);
            allUsersRef = db.ref("users");
            presenceRef = db.ref('/presence');
            connectedRef = db.ref('.info/connected');

            // Listener for current user's data
            currentUserRef.on("value", snapshot => {
                if (!snapshot.exists()) {
                    showFlashMessage("Data pengguna tidak ditemukan. Sesi Anda akan diakhiri.", "error");
                    auth.signOut();
                    return;
                }
                currentUserData = { id: user.uid, ...snapshot.val() };
                updateNavUser();
                updateStats();
                renderMembers(); // Re-render members whenever current user's data changes
            });

            // Listener for all users data
            allUsersRef.on("value", snapshot => {
                allUsersData = snapshot.val() || {};
                // Add id to each user object
                for (const id in allUsersData) {
                    allUsersData[id].id = id;
                }
                updateStats();
                renderMembers(); // Re-render members whenever all users data changes
            });

            // Presence system
            const userStatusDatabaseRef = db.ref('/presence/' + user.uid);
            
            presenceRef.on('value', snapshot => {
                const onlineCount = snapshot.numChildren();
                statOnlineMembers.textContent = onlineCount;
            });

            connectedRef.on('value', snapshot => {
                if (snapshot.val() === false) {
                    return;
                }
                userStatusDatabaseRef.onDisconnect().remove()
                    .then(() => {
                        userStatusDatabaseRef.set(true);
                    });
            });
        }

        function loadAllData() {
            console.log("Memulai loadAllData");
            db.ref("users").once("value").then(snapshot => {
                allUsersData = snapshot.val() || {};
                console.log("Data user yang diterima:", allUsersData);
                
                for (const id in allUsersData) {
                    allUsersData[id].id = id;
                }
                
                if (auth.currentUser) {
                    currentUserData = allUsersData[auth.currentUser.uid];
                    if (currentUserData) {
                        currentUserData.id = auth.currentUser.uid;
                        console.log("Current user data:", currentUserData);
                    }
                }
                
                updateStats();
                renderMembers();
            }).catch(err => {
                console.error("Error loadAllData:", err);
            });
        }

        // --- FIREBASE DATA FUNCTIONS ---
        function handleFollowRequest(otherUserId, otherUsername) {
            window.open(`https://www.tiktok.com/@${otherUsername}`, '_blank', 'noopener,noreferrer');
            
            const updates = {};
            updates[`/users/${currentUserData.id}/following/${otherUserId}`] = "pending";
            updates[`/users/${otherUserId}/followers/${currentUserData.id}`] = "pending";

            db.ref().update(updates)
                .then(() => {
                    showFlashMessage("Permintaan follow terkirim! Menunggu konfirmasi dari mereka.", "success");
                    // UI will update automatically via listeners
                })
                .catch(err => showFlashMessage(`Error: ${err.message}`, "error"));
        }

        function handleUnfollow(otherUserId) {
            // NOTE: In a production app, you would replace `confirm` with a custom modal for better UX.
            if (!confirm("Yakin mau berhenti mengikuti pengguna ini?")) return;

            const updates = {};
            updates[`/users/${currentUserData.id}/following/${otherUserId}`] = null; // null for deletion
            updates[`/users/${otherUserId}/followers/${currentUserData.id}`] = null;

            db.ref().update(updates)
                .then(() => {
                    showFlashMessage("Berhasil berhenti mengikuti.", "success");
                    // UI will update automatically via listeners
                })
                .catch(err => showFlashMessage(`Error: ${err.message}`, "error"));
        }

       // GANTI FUNGSI LAMA INI DI KODE ANDA
            function handleConfirmFollback(otherUserId) {
                if (!confirm("Konfirmasi bahwa Anda sudah follow balik pengguna ini? Ini akan membuat status menjadi 'Saling Follow'.")) return;

                const updates = {};
                // Buat status menjadi saling follow (confirmed) di semua jalur relasi
                updates[`/users/${currentUserData.id}/following/${otherUserId}`] = "confirmed";
                updates[`/users/${currentUserData.id}/followers/${otherUserId}`] = "confirmed";
                updates[`/users/${otherUserId}/followers/${currentUserData.id}`] = "confirmed";
                updates[`/users/${otherUserId}/following/${currentUserData.id}`] = "confirmed";

                db.ref().update(updates)
                    .then(() => {
                        showFlashMessage("Follback berhasil! Kalian sekarang saling follow.", "success");
                        loadAllData();
                    })
                    .catch(err => showFlashMessage(`Error: ${err.message}`, "error"));
            }

        // GANTI JUGA FUNGSI LAMA INI
        function handleRejectFollback(otherUserId) {
            if (!confirm("Yakin menolak permintaan follow ini? (Gunakan jika mereka ternyata tidak mem-follow Anda)")) return;
            
            const updates = {};
            // Hapus relasi dari kedua sisi agar data bersih
            updates[`/users/${currentUserData.id}/followers/${otherUserId}`] = null; // Hapus dari daftar follower saya
            updates[`/users/${otherUserId}/following/${currentUserData.id}`] = null; // Hapus dari daftar 'following' mereka

            db.ref().update(updates)
            .then(() => {
                    showFlashMessage("Permintaan follow ditolak.", "warning");
                    loadAllData();
                })
            .catch(err => showFlashMessage(`Error: ${err.message}`, "error"));
        }
                // --- AUTH STATE CHANGE HANDLER ---
                auth.onAuthStateChanged(user => {
                    // First, remove any existing listeners to prevent duplicates or issues on sign-out/in
                    if (currentUserRef) currentUserRef.off();
                    if (allUsersRef) allUsersRef.off();
                    if (presenceRef) presenceRef.off();
                    if (connectedRef) connectedRef.off();

                    if (user) {
                        // User is signed in.
                        setupRealtimeListeners(user);
                    } else {
                        // User is signed out.
                        currentUserData = null;
                        allUsersData = {};
                        sessionStorage.clear();
                        window.location.href = "login.html";
                    }
                });

        // --- EVENT LISTENERS ---
        document.addEventListener('click', function(e) {
            // Logout and Leaderboard buttons in nav
            if (e.target.id === 'logoutBtn') {
                auth.signOut();
            }
            if (e.target.id === 'leaderboardBtn') {
                showFlashMessage("Fitur Leaderboard segera hadir!", "info");
            }
            
            // Event delegation for action buttons in the list
            const actionButton = e.target.closest('[data-action]');
            if (actionButton) {
                const { action, userId, username } = actionButton.dataset;
                
                switch(action) {
                    case 'requestFollow':
                        handleFollowRequest(userId, username);
                        break;
                    case 'unfollow':
                        handleUnfollow(userId);
                        break;
                    case 'confirmFollback':
                        handleConfirmFollback(userId);
                        break;
                    case 'rejectFollback':
                        handleRejectFollback(userId);
                        break;
                }
            }
        });
        
        // Filter buttons
        filterButtons.forEach(button => {
            button.addEventListener("click", () => {
                // Remove active class from all buttons
                filterButtons.forEach(btn => btn.classList.remove("filter-btn-active"));
                // Add active class to the clicked button
                button.classList.add("filter-btn-active");
                
                activeFilter = button.id === 'filterAll' ? 'all' : 'not_follback';
                renderMembers();
            });
        });
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Saling Follow TikTok</title>

    <!-- Link ke font Inter dari Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Mengatur font Inter sebagai font default */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk tombol filter aktif */
        .filter-btn-active {
            background-color: #0d9488; /* bg-teal-600 */
            color: white;
            font-weight: 600; /* font-semibold */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-950 to-blue-950 min-h-screen">

    <nav class="bg-gray-900/50 shadow-xl backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-50 flex items-center gap-2">
                <!-- TikTok Logo SVG -->
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 448 512"
                  class="h-6 w-6"
                  fill="#FFFFFF"
                >
                  <path d="M448 209.9a210.1 210.1 0 0 1 -122.8-39.3V349.4A162.6 162.6 0 1 1 185 188.3V276a162.6 162.6 0 1 0 101.5 142.4V224.1c4.5 7.4 9.1 15.2 13.6 23.4l5.3 9.7L448 209.9z"/>
                </svg>
                Saling Follow TikTok
            </h1>
            <div id="navUserSection" class="text-sm flex flex-wrap gap-2 items-center">
                <!-- Informasi pengguna dan tombol akan dirender di sini -->
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto mt-6 px-4">

        <div id="flashMessage" class="hidden p-4 mb-4 rounded-lg text-sm"></div>

        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- Kartu Total Member -->
            <div class="bg-gray-800/40 p-6 rounded-2xl shadow-xl border border-gray-700 backdrop-blur-sm text-center">
                <p class="text-sm text-gray-400">Total Member Aktif</p>
                <p id="statTotalMembers" class="text-3xl font-bold text-gray-50 mt-1">0</p>
            </div>
            <!-- Kartu Member Online -->
            <div class="bg-gray-800/40 p-6 rounded-2xl shadow-xl border border-gray-700 backdrop-blur-sm text-center">
                <p class="text-sm text-gray-400">Member Online</p>
                <p id="statOnlineMembers" class="text-3xl font-bold text-teal-400 mt-1">0</p>
            </div>
            <!-- Kartu Kamu Mengikuti -->
            <div class="bg-gray-800/40 p-6 rounded-2xl shadow-xl border border-gray-700 backdrop-blur-sm text-center">
                <p class="text-sm text-gray-400">Kamu Mengikuti</p>
                <p id="statYouAreFollowing" class="text-3xl font-bold text-emerald-400 mt-1">0</p>
            </div>
            <!-- Kartu Mengikutimu -->
            <div class="bg-gray-800/40 p-6 rounded-2xl shadow-xl border border-gray-700 backdrop-blur-sm text-center">
                <p class="text-sm text-gray-400">Mengikutimu</p>
                <p id="statFollowingYou" class="text-3xl font-bold text-cyan-400 mt-1">0</p>
            </div>
        </section>

        <div class="mb-4 flex justify-between items-center flex-wrap gap-2">
            <h2 class="text-xl font-semibold text-gray-50">📋 Daftar Anggota</h2>
            <div class="flex gap-2">
                <button id="filterAll" class="filter-btn px-4 py-2 rounded-lg bg-gray-700/50 text-gray-300 text-sm transition filter-btn-active">Semua</button>
                <button id="filterNotFollback" class="filter-btn px-4 py-2 rounded-lg bg-gray-700/50 text-gray-300 text-sm transition">Belum Follback</button>
            </div>
        </div>

        <!-- Tampilan Tabel Desktop -->
        <div class="hidden sm:block overflow-x-auto">
            <table class="w-full bg-gray-800/40 shadow-xl rounded-2xl border border-gray-700 backdrop-blur-sm">
                <thead class="bg-gray-700/50 text-sm text-gray-200 uppercase">
                    <tr>
                        <th class="px-4 py-3 text-left">Username</th>
                        <th class="px-4 py-3 text-center">No. WA</th>
                        <th class="px-4 py-3 text-center">Skor</th>
                        <th class="px-4 py-3 text-center">Status</th>
                        <th class="px-4 py-3 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="text-gray-300">
                    <!-- Baris tabel akan dimasukkan secara dinamis di sini -->
                </tbody>
            </table>
        </div>

        <!-- Tampilan Kartu Mobile -->
        <div id="mobileList" class="sm:hidden grid grid-cols-1 gap-4">
            <!-- Kartu mobile akan dimasukkan secara dinamis di sini -->
        </div>

    </main>
    
    <footer class="mt-10 mb-6 text-center text-gray-400 text-sm">
        &copy; <span id="currentYear"></span> Saling Follow TikTok
    </footer>

    <!-- Custom Modal untuk Konfirmasi -->
    <div id="customModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div class="bg-gray-800 rounded-lg p-6 shadow-xl w-full max-w-sm border border-gray-700">
        <p id="modalMessage" class="text-gray-50 text-center mb-6 text-lg"></p>
        <div class="flex justify-center gap-4">
          <button id="modalConfirmBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-5 py-2 rounded-lg transition">Ya</button>
          <button id="modalCancelBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-5 py-2 rounded-lg transition">Batal</button>
        </div>
      </div>
    </div>

    <script type="module">
        // Import modul Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // Variabel global yang disediakan oleh lingkungan Canvas
        // Catatan: Pastikan __firebase_config diatur dengan benar di lingkungan Canvas Anda
        // jika Anda mengalami error 'auth/invalid-api-key'.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : {
                 apiKey: "AIzaSyDcgwRAwrLHKhtTmcmWucb1z3qTqbW0nbU",
                authDomain: "saling-follow.firebaseapp.com",
                databaseURL: "https://saling-follow-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "saling-follow",
                storageBucket: "saling-follow.firebasestorage.app",
                messagingSenderId: "1094414083730",
                appId: "1:1094414083730:web:d92a44972e226a5429284b",
                measurementId: "G-N3S79LL85E"
        });
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Elemen DOM
        const navUserSection = document.getElementById("navUserSection");
        const flashMessage = document.getElementById("flashMessage");
        const statTotalMembers = document.getElementById("statTotalMembers");
        const statOnlineMembers = document.getElementById("statOnlineMembers");
        const statYouAreFollowing = document.getElementById("statYouAreFollowing");
        const statFollowingYou = document.getElementById("statFollowingYou");
        const tableBody = document.getElementById("tableBody");
        const mobileList = document.getElementById("mobileList");
        const currentYear = document.getElementById("currentYear");
        const filterButtons = document.querySelectorAll(".filter-btn");

        // Elemen Modal
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        // Status Aplikasi
        let currentUserData = null;
        let allUsersData = {};
        let activeFilter = "all";
        let modalResolve = null; // Untuk menyimpan resolve promise modal

        // Referensi global untuk menyimpan listener aktif untuk pembersihan
        let currentUserRef = null;
        let allUsersRef = null;
        let presenceRef = null;
        let connectedRef = null;

        currentYear.innerText = new Date().getFullYear();

        // --- FUNGSI UTILITAS ---
        function showFlashMessage(text, type = "success") {
            flashMessage.textContent = text;
            flashMessage.className = "p-4 mb-4 rounded-lg text-sm"; // Reset kelas
            if (type === "success") {
                flashMessage.classList.add("bg-green-700/50", "text-green-200");
            } else if (type === "warning") {
                flashMessage.classList.add("bg-yellow-700/50", "text-yellow-200");
            } else if (type === "info") {
                flashMessage.classList.add("bg-blue-700/50", "text-blue-200");
            } else { // error
                flashMessage.classList.add("bg-red-700/50", "text-red-200");
            }
            flashMessage.classList.remove("hidden");
            setTimeout(() => {
                flashMessage.classList.add("hidden");
            }, 4000);
        }

        // Fungsi Modal Kustom
        function showCustomModal(message) {
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
            return new Promise((resolve) => {
                modalResolve = resolve;
            });
        }

        function hideCustomModal() {
            customModal.classList.add('hidden');
            modalResolve = null;
        }

        modalConfirmBtn.addEventListener('click', () => {
            if (modalResolve) modalResolve(true);
            hideCustomModal();
        });

        modalCancelBtn.addEventListener('click', () => {
            if (modalResolve) modalResolve(false);
            hideCustomModal();
        });

        // --- FUNGSI PEMBARUAN UI ---
        function updateNavUser() {
            if (!currentUserData) return;
            // Pastikan userId ditampilkan untuk aplikasi multi-pengguna
            const userIdDisplay = auth.currentUser?.uid || 'Anonim'; // Fallback untuk anonim
            navUserSection.innerHTML = `
                <span class="text-gray-300">Hai, <strong>${currentUserData.username}</strong></span>
                <span class="text-gray-400 text-xs">(ID: ${userIdDisplay.substring(0, 8)}...)</span>
                <button id="leaderboardBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded-lg text-sm font-semibold transition">🏆 Leaderboard</button>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm font-semibold transition">Logout</button>
            `;
        }
        
        function renderMembers() {
            tableBody.innerHTML = "";
            mobileList.innerHTML = "";
            
            if (!currentUserData) return;

            let filteredUsers = Object.values(allUsersData).filter(user => user.id !== currentUserData.id);

            if (activeFilter === "not_follback") {
                // Tampilkan user yang sudah follow kita ("pending"), tapi kita belum follback
                filteredUsers = filteredUsers.filter(user => {
                    const theyFollowYou = currentUserData.followers && currentUserData.followers[user.id];
                    const youFollowThem = currentUserData.following && currentUserData.following[user.id];
                    return theyFollowYou === "pending" && !youFollowThem;
                });
            }
            
            if (filteredUsers.length === 0) {
                const emptyMessage = `<tr class="border-t border-gray-700"><td colspan="5" class="text-center py-8 text-gray-500">Tidak ada anggota untuk ditampilkan.</td></tr>`;
                tableBody.innerHTML = emptyMessage;
                mobileList.innerHTML = `<div class="bg-gray-800/40 rounded-2xl shadow-xl p-6 text-center text-gray-400 border border-gray-700 backdrop-blur-sm">Tidak ada anggota untuk ditampilkan.</div>`;
                return;
            }

            filteredUsers.forEach(user => {
                const { statusLabel, actionsHTML } = getStatusAndActions(user);
                
                // Untuk Tabel Desktop
                const tr = document.createElement("tr");
                tr.className = "border-t border-gray-700 hover:bg-gray-700/30 transition";
                tr.innerHTML = `
                    <td class="px-4 py-3">${user.username}</td>
                    <td class="px-4 py-3 text-center text-gray-400">${user.whatsapp || "-"}</td>
                    <td class="px-4 py-3 text-center text-gray-200 font-semibold">${user.trust_score || 0}</td>
                    <td class="px-4 py-3 text-center text-xs">${statusLabel}</td>
                    <td class="px-4 py-3 text-center">${actionsHTML}</td>
                `;
                tableBody.appendChild(tr);

                // Untuk Kartu Mobile
                const card = document.createElement("div");
                card.className = "bg-gray-800/40 rounded-2xl shadow-xl p-6 border border-gray-700 backdrop-blur-sm";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-50">${user.username}</h3>
                            <p class="text-sm text-gray-400">${user.whatsapp || "-"}</p>
                            <p class="text-sm mt-1 text-gray-300">Skor: <span class="font-bold">${user.trust_score || 0}</span></p>
                        </div>
                        <div class="text-right text-xs shrink-0 ml-2">${statusLabel}</div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-gray-700 flex gap-2 flex-wrap">${actionsHTML}</div>
                `;
                mobileList.appendChild(card);
            });
        }
        
        function getStatusAndActions(otherUser) {
            const youFollowThem = currentUserData.following && currentUserData.following[otherUser.id];
            const theyFollowYou = currentUserData.followers && currentUserData.followers[otherUser.id];

            let statusLabel = `<span class="text-gray-500">Belum Follow</span>`;
            let actionsHTML = "";

            if (youFollowThem === "confirmed" && theyFollowYou === "confirmed") {
                statusLabel = `<span class="font-bold text-emerald-400">Saling Follow</span>`;
                actionsHTML = `<button data-action="unfollow" data-user-id="${otherUser.id}" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition">Unfollow</button>`;
            
            } else if (theyFollowYou === "pending") {
                statusLabel = `<span class="font-bold text-cyan-400">Telah Follow Anda</span><br><span class="text-gray-500 text-xs">(Verifikasi & Follback)</span>`;
                actionsHTML = `
                    <a href="https://www.tiktok.com/@${otherUser.username}" target="_blank" rel="noopener noreferrer" class="inline-block bg-sky-600 hover:bg-sky-700 text-white px-3 py-1 rounded-lg text-sm font-medium align-middle transition">Cek Profil</a>
                    <button data-action="confirmFollback" data-user-id="${otherUser.id}" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition">Sudah Follback</button>
                    <button data-action="rejectFollback" data-user-id="${otherUser.id}" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition" title="Klik jika sudah dicek dan ternyata belum follow">Tolak</button>
                `;

            } else if (youFollowThem === "pending") {
                statusLabel = `<span class="font-bold text-yellow-400">Menunggu Follback</span>`;
                actionsHTML = `<span class="text-gray-500 italic text-sm p-1">Menunggu...</span>`;
            
            } else if (youFollowThem === "confirmed") {
                statusLabel = `<span class="text-gray-400">Anda Follow</span>`;
                actionsHTML = `<button data-action="unfollow" data-user-id="${otherUser.id}" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition">Unfollow</button>`;
            
            } else { // Status default: Anda belum mengikuti mereka
                actionsHTML = `<button data-action="requestFollow" data-user-id="${otherUser.id}" data-username="${otherUser.username}" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition">Follow</button>`;
            }
            
            return { statusLabel, actionsHTML };
        }
        
        function updateStats() {
            if (!currentUserData) return;
            
            const totalMembers = Object.keys(allUsersData).length;
            const youAreFollowing = currentUserData.following ? Object.keys(currentUserData.following).filter(key => currentUserData.following[key] === 'confirmed').length : 0;
            const followingYou = currentUserData.followers ? Object.keys(currentUserData.followers).filter(key => currentUserData.followers[key] === 'confirmed').length : 0;
            
            statTotalMembers.textContent = totalMembers;
            statYouAreFollowing.textContent = youAreFollowing;
            statFollowingYou.textContent = followingYou;
        }

        // --- LISTENER DATA FIREBASE ---
        // Fungsi ini akan mengatur listener real-time untuk data pengguna
        function setupRealtimeListeners(user) {
            // Hapus listener yang ada terlebih dahulu untuk mencegah duplikasi
            if (currentUserRef) onValue(currentUserRef, () => {}); // Lepas listener sebelumnya
            if (allUsersRef) onValue(allUsersRef, () => {}); // Lepas listener sebelumnya
            if (presenceRef) onValue(presenceRef, () => {}); // Lepas listener sebelumnya
            if (connectedRef) onValue(connectedRef, () => {}); // Lepas listener sebelumnya

            // Jalur untuk SDK modular (DIKEMBALIKAN KE JALUR ASLI ANDA)
            currentUserRef = ref(db, `users/${user.uid}`);
            allUsersRef = ref(db, `users`);
            presenceRef = ref(db, `presence`);
            const userStatusDatabaseRef = ref(db, `presence/${user.uid}`);
            connectedRef = ref(db, '.info/connected');

            // Listener untuk data pengguna saat ini
            onValue(currentUserRef, snapshot => {
                console.log("currentUserRef snapshot received for UID:", user.uid);
                console.log("snapshot.exists():", snapshot.exists());
                console.log("snapshot.val():", snapshot.val());

                if (!snapshot.exists()) {
                    showFlashMessage("Data pengguna tidak ditemukan. Sesi Anda akan diakhiri.", "error");
                    signOut(auth);
                    return;
                }
                currentUserData = { id: user.uid, ...snapshot.val() };
                updateNavUser();
                updateStats();
                renderMembers(); // Render ulang anggota setiap kali data pengguna saat ini berubah
            });

            // Listener untuk semua data pengguna
            onValue(allUsersRef, snapshot => {
                console.log("allUsersRef snapshot received.");
                allUsersData = snapshot.val() || {};
                // Tambahkan id ke setiap objek pengguna
                for (const id in allUsersData) {
                    allUsersData[id].id = id;
                }
                updateStats();
                renderMembers(); // Render ulang anggota setiap kali semua data pengguna berubah
            });

            // Sistem Kehadiran (Presence)
            onValue(presenceRef, snapshot => {
                const onlineCount = snapshot.size; // Gunakan .size untuk SDK modular
                statOnlineMembers.textContent = onlineCount;
            });

            onValue(connectedRef, snapshot => {
                if (snapshot.val() === false) {
                    return;
                }
                // Saat terhubung, hapus pengguna dari kehadiran saat terputus
                set(userStatusDatabaseRef.onDisconnect(), null)
                    .then(() => {
                        set(userStatusDatabaseRef, true); // Set pengguna sebagai online
                    })
                    .catch(err => console.error("Error setting presence on connect:", err));
            });
        }

        // --- FUNGSI DATA FIREBASE ---
        async function handleFollowRequest(otherUserId, otherUsername) {
            const confirmed = await showCustomModal(`Anda akan diarahkan ke profil TikTok @${otherUsername}. Setelah follow, klik "Ya" untuk mengkonfirmasi.`);
            if (!confirmed) return;

            window.open(`https://www.tiktok.com/@${otherUsername}`, '_blank', 'noopener,noreferrer');
            
            const updates = {};
            // Jalur disesuaikan dengan struktur asli Anda
            updates[`users/${currentUserData.id}/following/${otherUserId}`] = "pending";
            updates[`users/${otherUserId}/followers/${currentUserData.id}`] = "pending";

            update(ref(db), updates)
                .then(() => {
                    showFlashMessage("Permintaan follow terkirim! Menunggu konfirmasi dari mereka.", "success");
                    // UI akan diperbarui secara otomatis melalui listener
                })
                .catch(err => showFlashMessage(`Error: ${err.message}`, "error"));
        }

        async function handleUnfollow(otherUserId) {
            const confirmed = await showCustomModal("Yakin mau berhenti mengikuti pengguna ini?");
            if (!confirmed) return;

            const updates = {};
            // Jalur disesuaikan dengan struktur asli Anda
            updates[`users/${currentUserData.id}/following/${otherUserId}`] = null; // null untuk penghapusan
            updates[`users/${otherUserId}/followers/${currentUserData.id}`] = null;

            update(ref(db), updates)
                .then(() => {
                    showFlashMessage("Berhasil berhenti mengikuti.", "success");
                    // UI akan diperbarui secara otomatis melalui listener
                })
                .catch(err => showFlashMessage(`Error: ${err.message}`, "error"));
        }

        async function handleConfirmFollback(otherUserId) {
            const confirmed = await showCustomModal("Konfirmasi bahwa Anda sudah follow balik pengguna ini? Ini akan membuat status menjadi 'Saling Follow'.");
            if (!confirmed) return;

            const updates = {};
            // Buat status menjadi saling follow (confirmed) di semua jalur relasi (jalur disesuaikan dengan struktur asli Anda)
            updates[`users/${currentUserData.id}/following/${otherUserId}`] = "confirmed";
            updates[`users/${currentUserData.id}/followers/${otherUserId}`] = "confirmed"; // Perbarui status follower lokal pengguna saat ini
            updates[`users/${otherUserId}/followers/${currentUserData.id}`] = "confirmed";
            updates[`users/${otherUserId}/following/${currentUserData.id}`] = "confirmed"; // Perbarui status following lokal pengguna lain

            update(ref(db), updates)
                .then(() => {
                    showFlashMessage("Follback berhasil! Kalian sekarang saling follow.", "success");
                    // UI akan diperbarui secara otomatis melalui listener
                })
                .catch(err => showFlashMessage(`Error: ${err.message}`, "error"));
        }

        async function handleRejectFollback(otherUserId) {
            const confirmed = await showCustomModal("Yakin menolak permintaan follow ini? (Gunakan jika mereka ternyata tidak mem-follow Anda)");
            if (!confirmed) return;
            
            const updates = {};
            // Hapus relasi dari kedua sisi agar data bersih (jalur disesuaikan dengan struktur asli Anda)
            updates[`users/${currentUserData.id}/followers/${otherUserId}`] = null; // Hapus dari daftar follower saya
            updates[`users/${otherUserId}/following/${currentUserData.id}`] = null; // Hapus dari daftar 'following' mereka

            update(ref(db), updates)
            .then(() => {
                showFlashMessage("Permintaan follow ditolak.", "warning");
                // UI akan diperbarui secara otomatis melalui listener
            })
            .catch(err => showFlashMessage(`Error: ${err.message}`, "error"));
        }

        // --- PENANGAN PERUBAHAN STATUS AUTH ---
        onAuthStateChanged(auth, user => {
            // Pertama, hapus listener yang ada untuk mencegah duplikasi atau masalah saat sign-out/in
            if (currentUserRef) onValue(currentUserRef, () => {});
            if (allUsersRef) onValue(allUsersRef, () => {});
            if (presenceRef) onValue(presenceRef, () => {});
            if (connectedRef) onValue(connectedRef, () => {});

            if (user) {
                // Pengguna masuk.
                setupRealtimeListeners(user);
            } else {
                // Pengguna keluar.
                currentUserData = null;
                allUsersData = {};
                // Hapus penyimpanan sesi jika digunakan untuk status auth
                sessionStorage.clear(); // Hapus komentar jika Anda menggunakan penyimpanan sesi
                window.location.href = "login.html"; // Arahkan ke halaman login
            }
        });

        // --- EVENT LISTENER ---
        document.addEventListener('click', function(e) {
            // Tombol Logout dan Leaderboard di nav
            if (e.target.id === 'logoutBtn') {
                signOut(auth);
            }
            if (e.target.id === 'leaderboardBtn') {
                showFlashMessage("Fitur Leaderboard segera hadir!", "info");
            }
            
            // Delegasi event untuk tombol aksi di daftar
            const actionButton = e.target.closest('[data-action]');
            if (actionButton) {
                const { action, userId, username } = actionButton.dataset;
                
                switch(action) {
                    case 'requestFollow':
                        handleFollowRequest(userId, username);
                        break;
                    case 'unfollow':
                        handleUnfollow(userId);
                        break;
                    case 'confirmFollback':
                        handleConfirmFollback(userId);
                        break;
                    case 'rejectFollback':
                        handleRejectFollback(userId);
                        break;
                }
            }
        });
        
        // Tombol Filter
        filterButtons.forEach(button => {
            button.addEventListener("click", () => {
                // Hapus kelas aktif dari semua tombol
                filterButtons.forEach(btn => btn.classList.remove("filter-btn-active"));
                // Tambahkan kelas aktif ke tombol yang diklik
                button.classList.add("filter-btn-active");
                
                activeFilter = button.id === 'filterAll' ? 'all' : 'not_follback';
                renderMembers();
            });
        });
        
    </script>
</body>
</html>
